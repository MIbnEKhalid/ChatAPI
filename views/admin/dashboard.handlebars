<div class="admin-container">
  <h1>Admin Dashboard</h1>
  <p class="welcome-message">Welcome, {{currentUser}}! <span class="last-updated">Last updated: {{formatDate "now"}}</span></p>
  
  <div class="admin-stats-grid">
    <!-- Total Chats -->
    <div class="stat-card">
      <div class="stat-value">{{stats.total_chats}}</div>
      <div class="stat-label">Total Chats</div>
      <div class="stat-trend {{#if (gt stats.active_chats_last_hour 10)}}up{{else}}down{{/if}}">
        {{stats.active_chats_last_hour}} in last hour
      </div>
    </div>
    
    <!-- Unique Users -->
    <div class="stat-card">
      <div class="stat-value">{{stats.unique_users}}</div>
      <div class="stat-label">Unique Users</div>
      <div class="stat-trend">
        {{stats.active_users_today}} active today
      </div>
    </div>
    
    <!-- Messages -->
    <div class="stat-card">
      <div class="stat-value">{{stats.messages_today}}</div>
      <div class="stat-label">Messages Today</div>
      <div class="stat-trend">
        <div id="hourlyChartContainer" style="height: 40px;"></div>
      </div>
    </div>
    
    <!-- Average Temp -->
    <div class="stat-card">
      <div class="stat-value">
        {{#if modelDistribution.0.avg_temp}}
          {{modelDistribution.0.avg_temp}}
        {{else}}
          -
        {{/if}}
      </div>
      <div class="stat-label">Avg Temperature</div>
      <div class="stat-trend">
        Top model: {{modelDistribution.0.ai_model}}
      </div>
    </div>
  </div>
  
  <div class="admin-section">
    <div class="section-header">
      <h2>Recent Chats</h2>
      <a href="/admin/chats" class="view-all-link">View All →</a>
    </div>
    <div class="recent-chats">
      {{#each recentChats}}
      <div class="chat-item">
        <div class="chat-header">
          <span class="chat-user">{{this.username}}</span>
          <span class="chat-time">{{formatDate this.created_at}}</span>
        </div>
        <div class="chat-meta">
          <span><strong>Model:</strong> {{this.ai_model}}</span>
          <span><strong>Temp:</strong> {{this.temperature}}</span>
          <span><strong>Msgs:</strong> {{this.message_count_in_chat}}</span>
        </div>
        <div class="chat-usage">
          <div class="usage-bar" style="width: {{divide this.message_count this.daily_message_limit 100}}%"></div>
          <span>{{this.message_count}}/{{this.daily_message_limit}}</span>
        </div>
        <a href="/chatbot/{{this.id}}" class="view-chat-btn">View Chat</a>
      </div>
      {{/each}}
    </div>
  </div>
  
  <div class="admin-columns">
    <div class="admin-column">
      <div class="section-header">
        <h2>Top Users by Messages</h2>
        <a href="/admin/users" class="view-all-link">View All →</a>
      </div>
      <div class="top-users">
        {{#each topUsers}}
        <div class="user-item">
          <div class="user-info">
            <span class="user-name">{{this.username}}</span>
            <span class="user-stats">{{this.active_days}} active days</span>
          </div>
          <div class="user-messages">
            <span class="message-count">{{this.total_messages}} total</span>
            <span class="peak-messages">Peak: {{this.peak_messages_in_day}}/day</span>
          </div>
        </div>
        {{/each}}
      </div>
    </div>
    
    <div class="admin-column">
      <div class="section-header">
        <h2>Model Distribution</h2>
      </div>
      <div class="model-distribution">
        {{#each modelDistribution}}
        <div class="model-item">
          <div class="model-info">
            <span class="model-name">{{this.ai_model}}</span>
            <span class="model-stats">Avg temp: {{this.avg_temp}}</span>
          </div>
          <div class="model-usage">
            <span class="model-count">{{this.count}} users</span>
            <span class="model-limit">Avg limit: {{this.avg_limit}}</span>
          </div>
        </div>
        {{/each}}
      </div>
    </div>
  </div>
  
  <div class="quick-actions">
    <h2>Quick Actions</h2>
    <div class="action-buttons">
      <a href="/admin/users" class="action-button">
        <i class="fas fa-users"></i>
        <span>Manage Users</span>
      </a>
      <a href="/admin/chats" class="action-button">
        <i class="fas fa-comments"></i>
        <span>Manage Chats</span>
      </a>
      <a href="/admin/users/export?format=csv" class="action-button">
        <i class="fas fa-file-export"></i>
        <span>Export Data</span>
      </a>
    </div>
  </div>
</div>

<style>
  .admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  h1 {
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
    padding-bottom: 10px;
    margin-bottom: 15px;
  }
  
  .welcome-message {
    color: #7f8c8d;
    font-style: italic;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
  }
  
  .last-updated {
    font-size: 0.8rem;
    color: #95a5a6;
  }
  
  .admin-stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .stat-card {
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
    position: relative;
  }
  
  .stat-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #3498db;
    margin-bottom: 5px;
  }
  
  .stat-label {
    color: #7f8c8d;
    font-size: 0.9rem;
    margin-bottom: 10px;
  }
  
  .stat-trend {
    font-size: 0.8rem;
    padding-top: 10px;
    border-top: 1px solid #ecf0f1;
  }
  
  .stat-trend.up {
    color: #27ae60;
  }
  
  .stat-trend.down {
    color: #e74c3c;
  }
  
  .admin-section {
    margin-bottom: 30px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 20px;
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  h2 {
    color: #2c3e50;
    margin: 0;
    font-size: 1.2rem;
  }
  
  .view-all-link {
    color: #3498db;
    text-decoration: none;
    font-size: 0.9rem;
  }
  
  .view-all-link:hover {
    text-decoration: underline;
  }
  
  .recent-chats {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
  }
  
  .chat-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .chat-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  
  .chat-user {
    font-weight: bold;
    color: #2c3e50;
  }
  
  .chat-time {
    color: #7f8c8d;
    font-size: 0.8rem;
  }
  
  .chat-meta {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 5px;
    font-size: 0.8rem;
    color: #7f8c8d;
    margin-bottom: 10px;
  }
  
  .chat-meta span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .chat-usage {
    margin-bottom: 10px;
    position: relative;
    height: 20px;
    background: #ecf0f1;
    border-radius: 4px;
    overflow: hidden;
  }
  
  .usage-bar {
    height: 100%;
    background: #3498db;
    transition: width 0.3s;
  }
  
  .chat-usage span {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.7rem;
    color: white;
    text-shadow: 0 0 2px rgba(0,0,0,0.5);
  }
  
  .view-chat-btn {
    display: inline-block;
    background: #3498db;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.8rem;
    transition: background 0.3s;
    width: 100%;
    text-align: center;
  }
  
  .view-chat-btn:hover {
    background: #2980b9;
  }
  
  .admin-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
  }
  
  .admin-column {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 20px;
  }
  
  .top-users, .model-distribution {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  
  .user-item, .model-item {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    border-radius: 4px;
    background: #f8f9fa;
  }
  
  .user-info, .model-info {
    display: flex;
    flex-direction: column;
  }
  
  .user-name, .model-name {
    font-weight: bold;
    margin-bottom: 3px;
  }
  
  .user-stats, .model-stats {
    font-size: 0.7rem;
    color: #7f8c8d;
  }
  
  .user-messages, .model-usage {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }
  
  .message-count, .model-count {
    font-weight: bold;
  }
  
  .peak-messages, .model-limit {
    font-size: 0.7rem;
    color: #7f8c8d;
  }
  
  .quick-actions {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 20px;
  }
  
  .action-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  .action-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background: #3498db;
    color: white;
    border-radius: 8px;
    text-decoration: none;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .action-button i {
    font-size: 1.5rem;
    margin-bottom: 10px;
  }
  
  .action-button span {
    font-size: 0.9rem;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Initialize hourly chart
  document.addEventListener('DOMContentLoaded', function() {
    const hourlyData = JSON.parse('{{{hourlyData}}}');
    
    const ctx = document.createElement('canvas');
    ctx.height = 40;
    document.getElementById('hourlyChartContainer').appendChild(ctx);
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: Array(24).fill().map((_, i) => i),
        datasets: [{
          data: hourlyData,
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.1)',
          borderWidth: 1,
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        },
        elements: {
          point: { radius: 0 }
        }
      }
    });
  });
</script>