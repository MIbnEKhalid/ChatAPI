<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> MBK_CHATAPI // {{username}}</title>
    <link rel="icon" type="image/x-icon" href="/Assets/Images/dgicon.svg">

    <!-- Fonts: JetBrains Mono (Coding Font) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100;300;400;500;700;800&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Code Highlighting -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark-reasonable.min.css">

    <!-- External Libs -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="/Assets/Scripts/logout.js"></script>

    <style>
        /* 
        ========================================
        CORE VARIABLES & RESET
        ========================================
        */
        :root {
            /* Cyberpunk / Hacker Palette */
            --term-bg: #050505;
            --term-panel: rgba(10, 15, 20, 0.95);
            --term-border: #3a3a3a;

            --neon-green: #00ff41;
            --neon-blue: #00f0ff;
            --neon-red: #ff003c;
            --neon-yellow: #fcee0a;
            --neon-purple: #bc13fe;

            --text-main: #e0e0e0;
            --text-dim: #888;

            --font-stack: 'JetBrains Mono', 'Fira Code', monospace;

            /* Dimensions */
            --header-height: 60px;
            --sidebar-width: 300px;

            /* Effects */
            --glass-blur: blur(12px);
            --glow-spread: 10px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: var(--term-bg);
            font-family: var(--font-stack);
            color: var(--text-main);
            font-size: 14px;
        }

        /* 
        ========================================
        MATRIX BACKGROUND CANVAS
        ========================================
        */
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.15;
            pointer-events: none;
        }

        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom,
                    rgba(255, 255, 255, 0),
                    rgba(255, 255, 255, 0) 50%,
                    rgba(0, 0, 0, 0.1) 50%,
                    rgba(0, 0, 0, 0.1));
            background-size: 100% 4px;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.3;
        }

        /* 
        ========================================
        APP LAYOUT
        ========================================
        */
        #app-root {
            position: relative;
            z-index: 1;
            display: flex;
            height: 100%;
            width: 100%;
            background: radial-gradient(circle at center, transparent 0%, #000 120%);
        }

        /* 
        ========================================
        SIDEBAR (HISTORY)
        ========================================
        */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--term-panel);
            border-right: 1px solid var(--term-border);
            display: flex;
            flex-direction: column;
            backdrop-filter: var(--glass-blur);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            z-index: 100;
            height: 100%;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--term-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand-text {
            color: var(--neon-green);
            font-weight: 800;
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-new-chat {
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-stack);
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-new-chat:hover {
            background: var(--neon-green);
            color: #000;
            box-shadow: 0 0 10px var(--neon-green);
        }

        /* Mobile Close Button (Hidden on Desktop) */
        .btn-close-sidebar {
            display: none;
            background: none;
            border: 1px solid var(--neon-red);
            color: var(--neon-red);
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .system-status {
            padding: 10px;
            font-size: 0.7rem;
            color: var(--text-dim);
            border-bottom: 1px dashed var(--term-border);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
        }

        .status-value {
            color: var(--neon-blue);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--term-border) transparent;
            /* subtle partition visual */
            border-right: 1px solid rgba(255, 255, 255, 0.03);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent 60%);
        }

        .chat-list::-webkit-scrollbar {
            width: 4px;
        }

        .chat-list::-webkit-scrollbar-thumb {
            background: var(--term-border);
        }

        .chat-group-title {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            margin: 15px 0 5px 5px;
            letter-spacing: 1px;
            border-bottom: 1px solid #222;
            padding-bottom: 2px;
        }

        .chat-item {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 2px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #ccc;
            background: rgba(255, 255, 255, 0.02);
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: var(--text-dim);
        }

        .chat-item.active {
            background: rgba(0, 240, 255, 0.1);
            border-left-color: var(--neon-blue);
            color: var(--neon-blue);
        }

        .chat-item-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .chat-item-delete {
            opacity: 0;
            color: var(--neon-red);
            background: none;
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
            padding: 5px;
        }

        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid var(--term-border);
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            background: var(--neon-purple);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(188, 19, 254, 0.4);
        }

        .user-info {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: #fff;
        }

        .user-role {
            font-size: 0.7rem;
            color: var(--neon-yellow);
            text-transform: uppercase;
        }

        .btn-settings {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s;
        }

        .btn-settings:hover {
            color: #fff;
            animation: rotateCog 2s linear infinite;
        }

        @keyframes rotateCog {
            100% {
                transform: rotate(360deg);
            }
        }

        /* 
        ========================================
        MAIN CHAT AREA
        ========================================
        */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            width: 100%;
        }

        .top-bar {
            height: var(--header-height);
            border-bottom: 1px solid var(--term-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(5px);
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--neon-green);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .model-indicator {
            font-size: 0.8rem;
            color: var(--neon-blue);
            border: 1px solid var(--neon-blue);
            padding: 4px 8px;
            border-radius: 2px;
            background: rgba(0, 240, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .model-indicator::before {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            background: var(--neon-blue);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--neon-blue);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: 15px;
            max-width: 85%;
            /* Removed animation to prevent flicker during redraws */
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.model {
            align-self: flex-start;
        }
        
        /* Legacy support for 'ai' class if used */
        .message.ai {
            align-self: flex-start;
        }

        .msg-avatar {
            width: 30px;
            height: 30px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .message.user .msg-avatar {
            background: var(--neon-purple);
            color: #fff;
            box-shadow: 0 0 8px rgba(188, 19, 254, 0.5);
        }

        .message.model .msg-avatar, .message.ai .msg-avatar {
            background: var(--neon-green);
            color: #000;
            box-shadow: 0 0 8px rgba(0, 255, 65, 0.5);
        }

        .msg-content {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--term-border);
            padding: 12px 18px;
            border-radius: 8px;
            position: relative;
            line-height: 1.6;
            overflow-wrap: break-word;
            min-width: 150px;
        }

        .message.user .msg-content {
            border-color: var(--neon-purple);
            background: rgba(188, 19, 254, 0.05);
            border-top-right-radius: 0;
        }

        .message.model .msg-content, .message.ai .msg-content {
            border-color: var(--neon-green);
            background: rgba(0, 255, 65, 0.02);
            border-top-left-radius: 0;
        }

        .msg-meta {
            display: flex;
            justify-content: space-between; /* Changed for branch nav */
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            font-size: 0.7rem;
            color: var(--text-dim);
            padding-top: 5px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .msg-actions button {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            transition: color 0.2s;
            margin-left: 5px;
        }

        .msg-actions button:hover {
            color: var(--neon-blue);
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            background: rgba(5, 5, 5, 0.95);
            border-top: 1px solid var(--term-border);
            position: relative;
            z-index: 50;
        }
        
        /* NEW: Editing Overlay */
        .editing-overlay {
            position: absolute;
            top: -40px;
            left: 20px;
            right: 20px;
            height: 35px;
            background: rgba(0, 240, 255, 0.1);
            border: 1px dashed var(--neon-blue);
            color: var(--neon-blue);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            border-radius: 4px;
            font-size: 0.85rem;
            backdrop-filter: blur(4px);
        }
        
        .btn-cancel-edit {
            background: none;
            border: none;
            color: var(--neon-red);
            cursor: pointer;
            font-weight: bold;
            font-family: var(--font-stack);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--term-border);
            border-radius: 8px;
            padding: 10px;
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--neon-green);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-family: var(--font-stack);
            font-size: 1rem;
            resize: none;
            outline: none;
            min-height: 24px;
            max-height: 200px;
            line-height: 1.5;
        }

        .input-actions {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-dim);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-send {
            background: var(--neon-green);
            color: #000;
        }

        .btn-send:hover {
            background: #00cc33;
            color: #000;
            transform: scale(1.05);
        }

        .btn-send:disabled {
            background: var(--term-border);
            cursor: not-allowed;
            transform: none;
        }

        /* NEW: Branch Navigation Styling */
        .branch-nav {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
            padding: 2px 4px;
        }
        
        .branch-count {
            font-family: var(--font-stack);
            font-size: 0.7rem;
            color: var(--text-dim);
            min-width: 30px;
            text-align: center;
        }
        
        .btn-branch {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.7rem;
            padding: 2px 4px;
        }
        
        .btn-branch:hover:not(:disabled) {
            color: #fff;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }
        
        .btn-branch:disabled {
            opacity: 0.3;
            cursor: default;
        }

        /* Markdown Styles */
        .msg-content p {
            margin-bottom: 10px;
        }

        .msg-content p:last-child {
            margin-bottom: 0;
        }

        .msg-content pre {
            background: #111;
            border: 1px solid var(--term-border);
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
        }

        .msg-content code {
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
        }

        .msg-content pre code {
            display: block;
            padding: 15px;
            overflow-x: auto;
            color: #abb2bf;
        }

        .btn-copy {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-copy:hover {
            color: var(--neon-green);
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            width: 90%;
            max-width: 700px;
            background: #0a0a0a;
            border: 1px solid var(--neon-green);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.1);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            animation: modalSlide 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        @keyframes modalSlide {
            from {
                transform: scale(0.9) translateY(20px);
                opacity: 0;
            }

            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--term-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            color: var(--neon-green);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: 400px;
        }

        .settings-nav {
            width: 180px;
            background: rgba(255, 255, 255, 0.02);
            border-right: 1px solid var(--term-border);
            padding: 10px;
        }

        .nav-item {
            display: block;
            width: 100%;
            padding: 12px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 5px;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .nav-item.active {
            background: rgba(0, 255, 65, 0.1);
            color: var(--neon-green);
            border-left: 2px solid var(--neon-green);
        }

        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--neon-blue);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid var(--term-border);
            color: #fff;
            border-radius: 4px;
            font-family: var(--font-stack);
        }

        .form-control:focus {
            border-color: var(--neon-green);
            outline: none;
        }

        .range-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            flex: 1;
            accent-color: var(--neon-green);
        }

        /* Account Card */
        .account-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--term-border);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .account-avatar-lg {
            width: 80px;
            height: 80px;
            background: var(--neon-purple);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 0 20px rgba(188, 19, 254, 0.3);
        }

        .limit-bar-bg {
            height: 10px;
            background: #222;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .limit-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
            width: 0%;
            transition: width 1s ease;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid var(--term-border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: var(--neon-green);
            color: #000;
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        .btn-danger {
            background: var(--neon-red);
            color: #fff;
        }

        /* Toasts */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: rgba(10, 20, 10, 0.95);
            border: 1px solid var(--neon-green);
            color: #fff;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
            animation: slideInToast 0.3s;
        }

        .toast.error {
            border-color: var(--neon-red);
        }

        @keyframes slideInToast {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Typing Dots */
        .typing-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--neon-green);
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* MOBILE RESPONSIVENESS */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 280px;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 2000;
                transform: translateX(-100%);
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.8);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            /* Show close button only on mobile */
            .btn-close-sidebar {
                display: flex;
            }

            .mobile-menu-btn {
                display: block;
            }

            .modal {
                width: 95%;
                height: 95%;
                max-height: none;
            }

            .modal-body {
                flex-direction: column;
            }

            .settings-nav {
                width: 100%;
                display: flex;
                overflow-x: auto;
                border-right: none;
                border-bottom: 1px solid var(--term-border);
            }

            .nav-item {
                flex: 0 0 auto;
                width: auto;
                margin-right: 5px;
                margin-bottom: 0;
            }

            .message {
                max-width: 95%;
            }
        }

        /* Splitter between sidebar and main content */
        .splitter {
            width: 6px;
            cursor: col-resize;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
            transition: background 0.15s;
            z-index: 150;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        .splitter:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .resizing * {
            cursor: col-resize !important;
        }
    </style>
</head>

<body>

    <!-- VISUAL EFFECTS -->
    <canvas id="matrix-canvas"></canvas>
    <div class="scanlines"></div>

    <!-- MAIN APP STRUCTURE -->
    <div id="app-root">

        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="brand-text">
                    <img src="https://mbktech.org/Assets/Images/Icon/dg.svg" alt="MBK Logo"
                        style="height: 24px; vertical-align: middle;"> MBK_CHATAPI
                </div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-new-chat" id="btn-new-chat">
                        <i class="fas fa-plus"></i>
                    </button>
                    <!-- Close button for mobile -->
                    <button class="btn-close-sidebar" id="btn-close-sidebar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Fake System Status -->
            <div class="system-status">
                <div class="status-row">
                    <span>NET_STATUS:</span> <span class="status-value">ONLINE</span>
                </div>
                <div class="status-row">
                    <span>ENCRYPTION:</span> <span class="status-value">AES-256</span>
                </div>
                <div class="status-row">
                    <span>LATENCY:</span> <span class="status-value" id="ping-val">24ms</span>
                </div>
            </div>

            <div class="chat-list" id="chat-list">
                <!-- Content injected by JS -->
                <div style="text-align: center; color: #555; margin-top: 20px;">
                    <i class="fas fa-circle-notch fa-spin"></i> INITIALIZING...
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="user-avatar">
                    {{#if username}}{{username.[0]}}{{else}}U{{/if}}
                </div>
                <div class="user-info">
                    <div class="user-name">{{username}}</div>
                    <div class="user-role">{{role}}</div>
                </div>
                <button class="btn-settings" id="btn-open-settings" title="Configuration">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </aside>

        <!-- Resizable Splitter -->
        <div id="splitter" class="splitter" aria-hidden="false" title="Drag to resize sidebar"></div>

        <!-- MAIN CONTENT -->
        <section class="main-content">
            <div class="top-bar">
                <button class="mobile-menu-btn" id="btn-toggle-sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="model-indicator" id="current-model-display">
                    <i class="fas fa-microchip"></i> <span id="model-name-text">GEMINI 1.5</span>
                </div>

            </div>

            <div class="messages-container" id="messages-container">
                <!-- Messages injected here via JS -->
                <div class="message model">
                    <div class="msg-avatar"><i class="fas fa-robot"></i></div>
                    <div class="msg-content">
                        <p>SYSTEM READY. Welcome back, <strong>{{username}}</strong>.</p>
                        <p>Select a protocol (model) from settings or begin typing to initialize a session.</p>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <!-- Editing Indicator -->
                <div class="editing-overlay" id="edit-overlay">
                    <span><i class="fas fa-pencil-alt"></i> EDITING MODE (Creates New Branch)</span>
                    <button class="btn-cancel-edit" id="btn-cancel-edit">CANCEL</button>
                </div>

                <div class="input-wrapper">
                    <textarea id="chat-input" placeholder="Enter command or message..." rows="1"></textarea>
                    <div class="input-actions">
                        <button class="btn-icon btn-send" id="btn-send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div style="text-align: right; font-size: 0.7rem; color: #555; margin-top: 5px;">
                    [ENTER] to send, [SHIFT+ENTER] for new line
                </div>
            </div>
        </section>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">System Configuration</div>
                <button class="btn-icon" id="btn-close-settings"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <nav class="settings-nav">
                    <button class="nav-item active" data-target="tab-bot">
                        <i class="fas fa-robot"></i> Bot Logic
                    </button>
                    <button class="nav-item" data-target="tab-ui">
                        <i class="fas fa-palette"></i> Interface
                    </button>
                    <button class="nav-item" data-target="tab-account">
                        <i class="fas fa-id-card"></i> Account
                    </button>
                </nav>

                <div class="settings-content">
                    <!-- BOT TAB -->
                    <div class="tab-pane active" id="tab-bot">
                        <div class="form-group">
                            <label>AI Model Selection (Efficient Tier)</label>
                            <select class="form-control" id="setting-model">
                                <optgroup label="Google Gemini">
                                    <option value="gemini/gemini-1.5-flash">Gemini 1.5 Flash (Reliable)</option>
                                    <option value="gemini/gemini-2.0-flash">Gemini 2.0 Flash (Fastest)</option>
                                </optgroup>
                                <optgroup label="Groq">
                                    <option value="groq/llama-3.1-8b-instant">Llama 3.1 8B (Instant)</option>
                                    <option value="groq/gemma2-9b-it">Gemma 2 9B (Google)</option>
                                </optgroup>
                                <optgroup label="Cerebras">
                                    <option value="cerebras/llama3.1-8b">Llama 3.1 8B (Super Fast)</option>
                                </optgroup>
                                <optgroup label="SambaNova">
                                    <option value="sambanova/Meta-Llama-3.1-8B-Instruct">Llama 3.1 8B (Balanced)</option>
                                </optgroup>
                                <optgroup label="Experimental">
                                    <option value="mallow/mallow-t1">Mallow T1 (Custom)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Creativity (Temperature): <span id="temp-val-display">0.7</span></label>
                            <div class="range-wrap">
                                <span>Precise</span>
                                <input type="range" id="setting-temp" min="0" max="200" value="70">
                                <span>Creative</span>
                            </div>
                        </div>
                    </div>

                    <!-- UI TAB -->
                    <div class="tab-pane" id="tab-ui">
                        <div class="form-group">
                            <label>Terminal Theme</label>
                            <select class="form-control" id="setting-theme">
                                <option value="cyberpunk">Cyberpunk (Default)</option>
                                <option value="matrix">Matrix Green</option>
                                <option value="clean">Clean Dark</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Font Size</label>
                            <input type="range" id="setting-font" min="12" max="20" value="14">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="setting-matrix-bg" checked> Enable Matrix Rain Background
                            </label>
                        </div>
                    </div>

                    <!-- ACCOUNT TAB -->
                    <div class="tab-pane" id="tab-account">
                        <div class="account-card">
                            <div class="account-avatar-lg">
                                {{#if username}}{{username.[0]}}{{else}}U{{/if}}
                            </div>
                            <h3 style="color:var(--neon-green);">{{username}}</h3>
                            <p style="color:var(--text-dim);">Role: {{role}}</p>

                            <div style="margin-top: 20px; text-align: left;">
                                <label>Daily Message Quota</label>
                                <div class="limit-bar-bg">
                                    <div class="limit-bar-fill" id="limit-bar" style="width: 0%;"></div>
                                </div>
                                <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                                    <span>Used: <span id="usage-count">{{limits.messageCount}}</span></span>
                                    <span>Limit: <span id="usage-limit">{{limits.dailyLimit}}</span></span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button onclick="logout()" class="btn btn-danger" style="width: 100%;">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                            <button onclick="location.href='https://portal.mbktech.org'" class="btn btn-"
                                style="width: 100%;">
                                <i class="fas fa-id-card"></i> Open Account Portal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btn-cancel-settings">Cancel</button>
                <button class="btn btn-primary" id="btn-save-settings">APPLY CONFIG</button>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <script>
        /* 
        ========================================
        1. MATRIX RAIN EFFECT
        ========================================
        */
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        let matrixInterval;

        function initMatrix() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
            const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const nums = '0123456789';
            const alphabet = katakana + latin + nums;
            const fontSize = 16;
            const columns = canvas.width / fontSize;
            const drops = [];

            for (let x = 0; x < columns; x++) {
                drops[x] = 1;
            }

            const draw = () => {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#0F0';
                ctx.font = fontSize + 'px monospace';

                for (let i = 0; i < drops.length; i++) {
                    const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            };

            if (matrixInterval) clearInterval(matrixInterval);
            matrixInterval = setInterval(draw, 30);
        }

        window.addEventListener('resize', () => {
            if (document.getElementById('setting-matrix-bg').checked) initMatrix();
        });

        /* 
        ========================================
        2. APPLICATION STATE
        ========================================
        */
        const AppState = {
            currentChatId: '{{chatId}}' === 'null' ? null : '{{chatId}}',
            username: '{{username}}',
            userRole: '{{role}}',
            isWaiting: false,
            // TREE LOGIC
            treeData: { nodes: {}, rootId: null, currentLeafId: null },
            editingNodeId: null,
            // SETTINGS
            settings: JSON.parse(localStorage.getItem('mbk_chat_settings')) || {
                model: 'gemini/gemini-1.5-flash',
                temperature: 0.7,
                theme: 'cyberpunk',
                fontSize: 14,
                matrixEnabled: true,
            }
        };

        const DOM = {
            input: document.getElementById('chat-input'),
            messages: document.getElementById('messages-container'),
            sidebar: document.getElementById('sidebar'),
            chatList: document.getElementById('chat-list'),
            modelDisplay: document.getElementById('model-name-text'),
            limitBar: document.getElementById('limit-bar'),
            limitCount: document.getElementById('usage-count'),
            limitTotal: document.getElementById('usage-limit'),
            editOverlay: document.getElementById('edit-overlay')
        };

        /* 
        ========================================
        3. UI CONTROLLER
        ========================================
        */
        const UI = {
            init: () => {
                UI.applySettings();
                UI.updateLimitBar(); 
                UI.setupEventListeners();
                UI.setupSplitter();
                UI.setupMarkdown();
                UI.loadHistory();

                if (AppState.currentChatId) {
                    Chat.load(AppState.currentChatId);
                }

                setInterval(() => {
                    document.getElementById('ping-val').innerText = Math.floor(Math.random() * 500 + 10) + 'ms';
                }, 2000);
            },

            setupSplitter: () => {
                const root = document.documentElement;
                const splitter = document.getElementById('splitter');
                const storageKey = 'mbk_sidebar_width';
                const minWidth = 200; 
                const maxWidth = Math.min(window.innerWidth - 300, 600);

                const stored = parseInt(localStorage.getItem(storageKey));
                if (stored && !isNaN(stored)) {
                    root.style.setProperty('--sidebar-width', stored + 'px');
                }

                let dragging = false;
                const onMouseMove = (e) => {
                    if (!dragging) return;
                    const newWidth = Math.max(minWidth, Math.min(maxWidth, e.clientX));
                    root.style.setProperty('--sidebar-width', newWidth + 'px');
                    localStorage.setItem(storageKey, newWidth);
                };
                const onMouseUp = () => {
                    if (dragging) {
                        dragging = false;
                        document.body.classList.remove('resizing');
                        window.removeEventListener('mousemove', onMouseMove);
                        window.removeEventListener('mouseup', onMouseUp);
                    }
                };
                splitter.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    dragging = true;
                    document.body.classList.add('resizing');
                    window.addEventListener('mousemove', onMouseMove);
                    window.addEventListener('mouseup', onMouseUp);
                });
            },

            applySettings: () => {
                const s = AppState.settings;
                if (s.matrixEnabled) { canvas.style.display = 'block'; initMatrix(); } 
                else { canvas.style.display = 'none'; if (matrixInterval) clearInterval(matrixInterval); }

                document.documentElement.style.fontSize = s.fontSize + 'px';
                const root = document.documentElement.style;
                if (s.theme === 'matrix') {
                    root.setProperty('--neon-green', '#0f0');
                    root.setProperty('--neon-blue', '#0f0');
                    root.setProperty('--neon-purple', '#0f0');
                    root.setProperty('--term-bg', '#000');
                } else if (s.theme === 'clean') {
                    root.setProperty('--term-bg', '#1e1e1e');
                    root.setProperty('--term-panel', '#252526');
                    root.setProperty('--neon-green', '#3794ff');
                } else {
                    root.removeProperty('--neon-green');
                    root.removeProperty('--term-bg');
                }

                const cleanModel = s.model.split('/')[1] || s.model;
                DOM.modelDisplay.innerText = cleanModel.toUpperCase();
                document.getElementById('setting-model').value = s.model;
                document.getElementById('setting-temp').value = s.temperature * 100;
                document.getElementById('temp-val-display').innerText = s.temperature;
                document.getElementById('setting-theme').value = s.theme;
                document.getElementById('setting-font').value = s.fontSize;
                document.getElementById('setting-matrix-bg').checked = s.matrixEnabled;
            },

            saveSettings: () => {
                const newSettings = {
                    model: document.getElementById('setting-model').value,
                    temperature: document.getElementById('setting-temp').value / 100,
                    theme: document.getElementById('setting-theme').value,
                    fontSize: document.getElementById('setting-font').value,
                    matrixEnabled: document.getElementById('setting-matrix-bg').checked,
                };
                AppState.settings = newSettings;
                localStorage.setItem('mbk_chat_settings', JSON.stringify(newSettings));
                UI.applySettings();
                UI.toggleModal('settings-modal', false);
                UI.showToast('Configuration System Updated', 'success');
            },

            toggleSidebar: () => { DOM.sidebar.classList.toggle('open'); },
            closeSidebar: () => { DOM.sidebar.classList.remove('open'); },
            toggleModal: (id, show) => {
                const el = document.getElementById(id);
                if (show) el.classList.add('active'); else el.classList.remove('active');
            },

            showToast: (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                let icon = type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle';
                if (type === 'success') icon = 'fa-check-circle';

                toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = 0;
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            updateLimitBar: () => {
                const role = AppState.userRole;
                const isAdmin = role === 'Admin' || role === 'SuperAdmin';
                if (isAdmin) {
                    DOM.limitBar.style.width = '100%';
                    DOM.limitBar.style.background = 'var(--neon-green)'; 
                    DOM.limitTotal.innerText = 'UNLIMITED';
                    return;
                }
                const count = parseInt(DOM.limitCount.innerText) || 0;
                const limit = parseInt(DOM.limitTotal.innerText) || 100;
                const pct = Math.min((count / limit) * 100, 100);
                DOM.limitBar.style.width = pct + '%';
                if (pct > 90) DOM.limitBar.style.background = 'var(--neon-red)';
                else DOM.limitBar.style.background = 'linear-gradient(90deg, var(--neon-green), var(--neon-blue))';
            },

            scrollToBottom: () => { DOM.messages.scrollTop = DOM.messages.scrollHeight; },

            setupMarkdown: () => {
                marked.setOptions({
                    highlight: function (code, lang) {
                        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                        return hljs.highlight(code, { language }).value;
                    },
                    langPrefix: 'hljs language-'
                });
            },

            loadHistory: async () => {
                try {
                    const res = await fetch('/api/chat/histories');
                    const data = await res.json();
                    DOM.chatList.innerHTML = '';
                    let hasChats = false;

                    const renderGroup = (title, items) => {
                        if (!items || !items.length) return;
                        hasChats = true;
                        const titleEl = document.createElement('div');
                        titleEl.className = 'chat-group-title';
                        titleEl.innerText = title;
                        DOM.chatList.appendChild(titleEl);

                        items.forEach(chat => {
                            const el = document.createElement('div');
                            el.className = `chat-item ${chat.id === AppState.currentChatId ? 'active' : ''}`;
                            el.innerHTML = `
                                <span class="chat-item-title"><i class="fas fa-comment-alt"></i> ${chat.created_at}</span>
                                <button class="chat-item-delete" onclick="Chat.delete('${chat.id}', event)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                            el.onclick = (e) => {
                                if (!e.target.closest('.chat-item-delete')) {
                                    window.location.href = `/chatbot/${chat.id}`;
                                }
                            };
                            DOM.chatList.appendChild(el);
                        });
                    };

                    renderGroup('TODAY', data.today);
                    renderGroup('YESTERDAY', data.yesterday);
                    renderGroup('OLDER', data.older); // Check specific backend keys

                    if (!hasChats) DOM.chatList.innerHTML = '<div style="padding:10px; color:#555;">NO LOGS FOUND</div>';

                } catch (e) {
                    console.error(e);
                    DOM.chatList.innerHTML = '<div style="color:red; padding:10px;">ERROR LOADING HISTORY</div>';
                }
            },

            setupEventListeners: () => {
                document.getElementById('btn-toggle-sidebar').onclick = UI.toggleSidebar;
                document.getElementById('btn-close-sidebar').onclick = UI.closeSidebar;
                document.getElementById('btn-new-chat').onclick = () => window.location.href = '/chatbot';

                document.getElementById('btn-open-settings').onclick = () => UI.toggleModal('settings-modal', true);
                document.getElementById('btn-close-settings').onclick = () => UI.toggleModal('settings-modal', false);
                document.getElementById('btn-cancel-settings').onclick = () => UI.toggleModal('settings-modal', false);
                document.getElementById('btn-save-settings').onclick = UI.saveSettings;
                document.getElementById('btn-cancel-edit').onclick = Chat.cancelEdit;

                document.querySelectorAll('.nav-item').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                        btn.classList.add('active');
                        document.getElementById(btn.dataset.target).classList.add('active');
                    };
                });

                DOM.input.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                    document.getElementById('btn-send').disabled = this.value.trim() === '';
                });

                DOM.input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        Chat.send();
                    }
                });

                document.getElementById('btn-send').onclick = Chat.send;
                document.getElementById('setting-temp').addEventListener('input', (e) => {
                    document.getElementById('temp-val-display').innerText = e.target.value / 100;
                });
            }
        };

        /* 
        ========================================
        4. CHAT LOGIC (TREE / BRANCHING)
        ========================================
        */
        const Chat = {
            send: async () => {
                const text = DOM.input.value.trim();
                if (!text || AppState.isWaiting) return;

                // Prepare request
                // If editing, parent is the parent of the edited node. If not, parent is currentLeaf.
                let parentId = AppState.treeData.currentLeafId;
                if (AppState.editingNodeId && AppState.treeData.nodes[AppState.editingNodeId]) {
                    parentId = AppState.treeData.nodes[AppState.editingNodeId].parentId;
                }

                // UI Immediate Feedback
                DOM.input.value = '';
                DOM.input.style.height = 'auto';
                Chat.cancelEdit();
                AppState.isWaiting = true;
                
                // Add a temporary "User" message to UI (removed on render)
                const tempUser = document.createElement('div');
                tempUser.className = 'message user';
                tempUser.innerHTML = `<div class="msg-avatar"><i class="fas fa-user"></i></div><div class="msg-content">${text}</div>`;
                DOM.messages.appendChild(tempUser);
                
                const typingId = Chat.addTypingIndicator();

                try {
                    const payload = {
                        message: text,
                        chatId: AppState.currentChatId,
                        parentMessageId: parentId, // For Branching
                        model: AppState.settings.model,
                        temperature: AppState.settings.temperature
                    };

                    const res = await fetch('/api/bot-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    document.getElementById(typingId).remove();
                    tempUser.remove(); // Remove fake message, full render comes next

                    if (res.ok) {
                        // Update State
                        AppState.currentChatId = data.newChatId;
                        AppState.treeData = data.treeData; // Sync Tree
                        
                        // If url needs update
                        if(!window.location.href.includes(data.newChatId)) {
                             history.pushState({}, '', `/chatbot/${data.newChatId}`);
                             UI.loadHistory();
                        }
                        
                        // Full Re-render based on tree
                        Chat.renderTree();

                        // Count update
                        if (AppState.userRole !== 'Admin' && AppState.userRole !== 'SuperAdmin') {
                            const current = parseInt(DOM.limitCount.innerText);
                            DOM.limitCount.innerText = current + 1;
                            UI.updateLimitBar();
                        }
                    } else {
                        throw new Error(data.message || 'Unknown Error');
                    }

                } catch (e) {
                    if (document.getElementById(typingId)) document.getElementById(typingId).remove();
                    UI.showToast(e.message, 'error');
                } finally {
                    AppState.isWaiting = false;
                }
            },

            // Renders the Linear Thread from Tree Data
            renderTree: () => {
                DOM.messages.innerHTML = '';
                const { nodes, currentLeafId } = AppState.treeData;
                
                // Traverse up from leaf
                let thread = [];
                let curr = currentLeafId;
                while(curr && nodes[curr]) {
                    thread.unshift(nodes[curr]);
                    curr = nodes[curr].parentId;
                }
                
                // Render each node
                thread.forEach(node => {
                    if(node.role === 'system') return; // Skip system
                    
                    const div = document.createElement('div');
                    const roleClass = node.role === 'model' ? 'model' : 'user';
                    div.className = `message ${roleClass}`;
                    const icon = roleClass === 'user' ? 'fa-user' : 'fa-robot';
                    
                    let contentHtml = roleClass === 'model' ? marked.parse(node.text) : node.text.replace(/\n/g, '<br>');

                    // Navigation Logic (Siblings)
                    let navHtml = '';
                    if(node.parentId && nodes[node.parentId]) {
                        const siblings = nodes[node.parentId].children;
                        if(siblings.length > 1) {
                            const idx = siblings.indexOf(node.id);
                            const total = siblings.length;
                            navHtml = `
                                <div class="branch-nav">
                                    <button class="btn-branch" onclick="Chat.switchBranch('${siblings[Math.max(0, idx-1)]}')" ${idx===0?'disabled':''}><</button>
                                    <span class="branch-count">${idx+1}/${total}</span>
                                    <button class="btn-branch" onclick="Chat.switchBranch('${siblings[Math.min(total-1, idx+1)]}')" ${idx===total-1?'disabled':''}>></button>
                                </div>
                            `;
                        }
                    }

                    // Edit Button (User Only)
                    const editBtn = roleClass === 'user' ? 
                        `<button onclick="Chat.startEdit('${node.id}')" title="Edit"><i class="fas fa-pencil-alt"></i></button>` : '';

                    div.innerHTML = `
                        <div class="msg-avatar"><i class="fas ${icon}"></i></div>
                        <div class="msg-content">
                            ${contentHtml}
                            <div class="msg-meta">
                                ${navHtml || '<span></span>'} 
                                <div class="msg-actions">
                                    ${editBtn}
                                    <button onclick="Chat.copyText(this)" title="Copy"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    DOM.messages.appendChild(div);
                });
                
                UI.scrollToBottom();
                UI.setupMarkdown(); // Re-apply highlighting
            },

            switchBranch: (nodeId) => {
                // Find latest leaf of this branch to set as current
                let curr = nodeId;
                while(AppState.treeData.nodes[curr] && AppState.treeData.nodes[curr].children.length > 0) {
                     const kids = AppState.treeData.nodes[curr].children;
                     curr = kids[kids.length - 1]; // Go to latest
                }
                AppState.treeData.currentLeafId = curr;
                Chat.renderTree();
            },

            startEdit: (nodeId) => {
                if(!AppState.treeData.nodes[nodeId]) return;
                AppState.editingNodeId = nodeId;
                DOM.input.value = AppState.treeData.nodes[nodeId].text;
                DOM.input.focus();
                DOM.editOverlay.style.display = 'flex';
            },

            cancelEdit: () => {
                AppState.editingNodeId = null;
                DOM.input.value = '';
                DOM.editOverlay.style.display = 'none';
            },

            addTypingIndicator: () => {
                const id = 'typing-' + Date.now();
                const div = document.createElement('div');
                div.className = 'message model';
                div.id = id;
                div.innerHTML = `
                    <div class="msg-avatar"><i class="fas fa-robot"></i></div>
                    <div class="msg-content" style="min-width: 60px;">
                        <div class="typing-dots"><span></span><span></span><span></span></div>
                    </div>
                `;
                DOM.messages.appendChild(div);
                UI.scrollToBottom();
                return id;
            },

            load: async (id) => {
                DOM.messages.innerHTML = '';
                const loader = Chat.addTypingIndicator();
                try {
                    const res = await fetch(`/api/chat/histories/${id}`);
                    if (!res.ok) throw new Error('Failed to load chat');
                    const data = await res.json();
                    document.getElementById(loader).remove();

                    if (data.treeData) {
                        AppState.treeData = data.treeData;
                        Chat.renderTree();
                    } else if (data.conversation_history) {
                        // Fallback for old linear data
                        // (You might want to convert this on backend, but here is a simple display)
                        const history = typeof data.conversation_history === 'string' ? JSON.parse(data.conversation_history) : data.conversation_history;
                        // Construct a fake tree for display
                         // ... (Omitted for brevity, assuming backend migration handled)
                    }
                } catch (e) {
                    if(document.getElementById(loader)) document.getElementById(loader).remove();
                    UI.showToast('Could not load history', 'error');
                }
            },

            delete: async (id, e) => {
                e.stopPropagation();
                if (!confirm('CONFIRM DELETION: This action cannot be undone.')) return;
                try {
                    const res = await fetch(`/api/chat/clear-history/${id}`, { method: 'POST' });
                    if (res.ok) {
                        if (AppState.currentChatId === id) window.location.href = '/chatbot';
                        else UI.loadHistory();
                        UI.showToast('Log Deleted', 'success');
                    }
                } catch (e) { UI.showToast('Deletion Failed', 'error'); }
            },

            copyText: (btn) => {
                const content = btn.closest('.msg-content').innerText;
                navigator.clipboard.writeText(content);
                UI.showToast('Copied to clipboard', 'success');
            }
        };

        /* 
        ========================================
        5. INITIALIZATION
        ========================================
        */
        document.addEventListener('DOMContentLoaded', UI.init);
    </script>
</body>

</html>